{% extends "base.html" %}

{% block title %}Книга — ЦБС Вологды{% endblock %}

{% block content %}
<!-- Loading State -->
<div id="loading-state" class="py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="animate-pulse">
            <div class="h-4 bg-slate-200 rounded w-32 mb-6"></div>
            <div class="flex gap-6">
                <div class="w-48 h-64 bg-slate-200 rounded-lg"></div>
                <div class="flex-grow space-y-4">
                    <div class="h-8 bg-slate-200 rounded w-3/4"></div>
                    <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                    <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                    <div class="h-24 bg-slate-200 rounded"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Book Content -->
<div id="book-content" class="hidden">
    <!-- Back Link -->
    <div class="bg-white border-b border-slate-200 py-4">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <a href="javascript:history.back()" class="inline-flex items-center text-slate-500 hover:text-blue-700 transition">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                <span>Назад к результатам</span>
            </a>
        </div>
    </div>
    
    <!-- Book Info -->
    <section class="py-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Book Cover -->
                <div class="w-full md:w-48 flex-shrink-0">
                    <div class="aspect-[2/3] bg-slate-100 rounded-xl flex items-center justify-center">
                        <i data-lucide="book" class="w-16 h-16 text-slate-300"></i>
                    </div>
                </div>
                
                <!-- Book Details -->
                <div class="flex-grow">
                    <h1 id="book-title" class="text-2xl md:text-3xl font-bold text-slate-900 mb-2"></h1>
                    <p class="text-lg text-slate-600 mb-4">
                        <span id="book-author"></span>
                        <span id="book-year" class="text-slate-400"></span>
                    </p>
                    
                    <div class="flex items-center gap-4 mb-6">
                        <span id="availability-badge" class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium"></span>
                        <span id="book-isbn" class="text-sm text-slate-500"></span>
                    </div>
                    
                    <div id="book-description" class="text-slate-700 leading-relaxed mb-8"></div>
                    
                    <!-- Availability Table -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-semibold text-slate-900 flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-5 h-5"></i>
                                Наличие в библиотеках
                            </h3>
                        </div>
                        <div id="availability-table" class="divide-y divide-slate-200">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Error State -->
<div id="error-state" class="hidden py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
            <i data-lucide="alert-circle" class="w-8 h-8 text-red-600"></i>
        </div>
        <h2 class="text-xl font-semibold text-slate-900 mb-2">Книга не найдена</h2>
        <p class="text-slate-600 mb-4">Возможно, она была удалена или вы перешли по неверной ссылке</p>
        <a href="/" class="inline-flex items-center space-x-2 text-blue-700 hover:text-blue-800 font-medium">
            <span>Вернуться на главную</span>
            <i data-lucide="arrow-right" class="w-4 h-4"></i>
        </a>
    </div>
</div>

<!-- Load Book Data -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const bookId = {{ book_id }};
        
        fetch(`/api/v1/books/${bookId}`)
            .then(response => {
                if (!response.ok) throw new Error('Book not found');
                return response.json();
            })
            .then(book => {
                // Hide loading, show content
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('book-content').classList.remove('hidden');
                
                // Fill book info
                document.getElementById('book-title').textContent = book.title;
                document.getElementById('book-author').textContent = book.author_name || 'Автор не указан';
                document.getElementById('book-year').textContent = book.year ? `, ${book.year}` : '';
                document.getElementById('book-isbn').textContent = book.isbn ? `ISBN: ${book.isbn}` : '';
                document.getElementById('book-description').textContent = book.description || 'Описание отсутствует';
                
                // Availability badge
                const badge = document.getElementById('availability-badge');
                if (book.available_count > 0) {
                    badge.className = 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700';
                    badge.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i>Доступно: ${book.available_count} из ${book.total_count}`;
                } else {
                    badge.className = 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-700';
                    badge.innerHTML = `<i data-lucide="x-circle" class="w-4 h-4"></i>Нет в наличии`;
                }
                
                // Availability table
                const tableContainer = document.getElementById('availability-table');
                if (book.copies_by_library && book.copies_by_library.length > 0) {
                    tableContainer.innerHTML = book.copies_by_library.map(copy => `
                        <div class="px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-100 p-2 rounded">
                                    <i data-lucide="library" class="w-4 h-4 text-blue-700"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-slate-900">${copy.library_name}</p>
                                    <p class="text-sm text-slate-500">Инв. №: ${copy.inventory_number}</p>
                                </div>
                            </div>
                            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${copy.status === 'available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${copy.status === 'available' 
                                    ? '<i data-lucide="check" class="w-4 h-4"></i>На полке' 
                                    : '<i data-lucide="clock" class="w-4 h-4"></i>Выдана'}
                            </span>
                        </div>
                    `).join('');
                } else {
                    tableContainer.innerHTML = `
                        <div class="px-6 py-8 text-center text-slate-500">
                            Нет информации о наличии
                        </div>
                    `;
                }
                
                // Re-initialize icons
                lucide.createIcons();
            })
            .catch(error => {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                lucide.createIcons();
            });
    });
</script>
{% endblock %}
